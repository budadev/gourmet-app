<!-- =============================
File: index.html
Purpose: GourmetApp ‚Äî installable PWA that scans barcodes, stores items in local IndexedDB, supports search, optional lookup via Open Food Facts
How to use:
 1) Save files as shown below (index.html, sw.js, manifest.webmanifest).
 2) Serve over HTTPS (required for camera). Any static host works (Cloudflare Pages, GitHub Pages, Netlify, simple HTTPS server).
 3) On iPhone: open in Safari ‚Üí Share ‚Üí Add to Home Screen. First launch will ask for camera permission when scanning.
================================ -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GourmetApp</title>
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <style>
        :root{--bg:#0b1220;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--acc:#34d399}
        *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
        header{position:sticky;top:0;background:linear-gradient(180deg,#0b1220,#0b1220cc);backdrop-filter:blur(8px);padding:12px 16px;border-bottom:1px solid #1f2937}
        h1{margin:0;font-size:18px;letter-spacing:.5px}
        main{max-width:860px;margin:0 auto;padding:16px}
        .row{display:flex;gap:8px;flex-wrap:wrap}
        .btn{appearance:none;border:1px solid #374151;background:#111827;color:#e5e7eb;border-radius:12px;padding:10px 14px;font-weight:600}
        .btn.primary{background:#10b981;border-color:#10b981;color:#06281f}
        .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
        input,select,textarea{width:100%;background:#0b1220;border:1px solid #374151;border-radius:10px;color:#e5e7eb;padding:10px}
        label{font-size:12px;color:var(--muted)}
        .grid{display:grid;grid-template-columns:1fr;gap:12px}
        @media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
        .list{display:grid;gap:10px;margin-top:12px}
        .item{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px}
        .muted{color:var(--muted)}
        video{width:100%;border-radius:16px;background:#000}
        .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b3c2f;color:#a7f3d0;border:1px solid #065f46;font-size:12px}
    </style>
</head>
<body>
<header><h1>ü•ò GourmetApp</h1></header>
<main>
    <div class="row" style="margin-bottom:12px">
        <button class="btn" id="scanBtn">Scan Barcode</button>
        <button class="btn" id="stopScanBtn" disabled>Stop Scan</button>
        <button class="btn" id="addManualBtn">Add Item</button>
        <input id="searchInput" placeholder="Search by text or barcode‚Ä¶"/>
        <button class="btn" id="searchBtn">Search</button>
        <button class="btn" id="showAllBtn">Show All</button>
    </div>

    <section id="scanner" class="card" style="display:none">
        <label>Camera preview</label>
        <video id="preview" playsinline></video>
        <div class="muted" id="scanHint">Point your camera at a barcode (EAN/UPC/Code128).</div>
    </section>

    <section class="card">
        <h3 style="margin:0 0 10px">Item Editor</h3>
        <div class="grid">
            <div><label>Type</label><select id="type"><option value="food">Food</option><option value="drink">Drink</option></select></div>
            <div><label>Name</label><input id="name" placeholder="e.g., Margherita Pizza or Cabernet Sauvignon"/></div>
            <div><label>Barcode (optional)</label><input id="barcode" placeholder="e.g., 5991234567890"/></div>
            <div><label>Rating (0‚Äì5)</label><input id="rating" type="number" min="0" max="5" step="0.5"/></div>
            <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="3" placeholder="Tasting notes, where you had it, etc."></textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
            <button class="btn primary" id="saveBtn">Save</button>
            <button class="btn" id="clearBtn">Clear</button>
        </div>
        <div class="muted" id="status"></div>
    </section>

    <section class="card">
        <h3 style="margin:0 0 10px">Results</h3>
        <div id="results" class="list"></div>
    </section>
</main>

<!-- ZXing barcode scanner via ESM build -->
<script type="module">
    // ====== Simple IndexedDB wrapper (no external deps) ======
    const DB_NAME = 'gourmetapp-db';
    const STORE = 'items';
    const dbp = new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        const store = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
        store.createIndex('by_barcode', 'barcode', { unique: false });
        store.createIndex('by_name', 'name', { unique: false });
        store.createIndex('by_type', 'type', { unique: false });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });

    async function tx(mode = 'readonly') {
      const db = await dbp; return db.transaction(STORE, mode).objectStore(STORE);
    }
    async function addItem(item){ const store = await tx('readwrite'); return new Promise((res,rej)=>{ const r=store.add({...item, createdAt: Date.now(), updatedAt: Date.now()}); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
    async function updateItem(id, patch){ const store = await tx('readwrite'); const get=store.get(id); return new Promise((res,rej)=>{ get.onsuccess=()=>{ const cur=get.result; if(!cur) return rej(new Error('Not found')); const put=store.put({...cur, ...patch, updatedAt: Date.now()}); put.onsuccess=()=>res(put.result); put.onerror=()=>rej(put.error); }; get.onerror=()=>rej(get.error); }); }
    async function listAll(){ const store = await tx('readonly'); return new Promise((res)=>{ const out=[]; const c=store.openCursor(); c.onsuccess=()=>{ const cur=c.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out); }; }); }
    async function findByBarcode(code){ const store = await tx('readonly'); return new Promise((res)=>{ const idx=store.index('by_barcode'); const r=idx.getAll(code); r.onsuccess=()=>res(r.result||[]); }); }
    async function searchByText(q){ q=(q||'').toLowerCase(); if(!q) return listAll(); const all=await listAll(); return all.filter(it => (it.name||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q) || (it.barcode||'').includes(q)); }

    // ====== UI helpers ======
    const el = id => document.getElementById(id);
    const resultsEl = el('results');
    function renderList(items){
      resultsEl.innerHTML = items.map(it => `
        <div class="item">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">${escapeHtml(it.name||'Unnamed')}</div>
              <div class="muted">${it.type||'unknown'}${it.barcode?` ¬∑ ${it.barcode}`:''}</div>
            </div>
            <div><span class="badge">‚≠ê ${Number(it.rating||0).toFixed(1)}</span></div>
          </div>
          ${it.notes?`<div style="margin-top:8px">${escapeHtml(it.notes)}</div>`:''}
          <div class="muted" style="margin-top:6px">Updated: ${new Date(it.updatedAt||Date.now()).toLocaleString()}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-edit="${it.id}">Edit</button>
            <button class="btn" data-delete="${it.id}">Delete</button>
          </div>
        </div>`).join('');
      // bind edit/delete
      resultsEl.querySelectorAll('[data-edit]').forEach(b=> b.onclick = async ()=>{
        const id = Number(b.getAttribute('data-edit'));
        const all = await listAll();
        const item = all.find(x=>x.id===id); if(!item) return;
        el('type').value = item.type||'food';
        el('name').value = item.name||'';
        el('barcode').value = item.barcode||'';
        el('rating').value = item.rating||'';
        el('notes').value = item.notes||'';
        el('saveBtn').dataset.editing = String(id);
        setStatus(`Editing #${id}‚Ä¶`);
      });
      resultsEl.querySelectorAll('[data-delete]').forEach(b=> b.onclick = async ()=>{
        const id = Number(b.getAttribute('data-delete'));
        const store = await tx('readwrite');
        store.delete(id).onsuccess = async ()=>{ setStatus('Deleted.'); renderList(await listAll()); };
      });
    }
    function setStatus(msg){ el('status').textContent = msg; }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ====== External lookup (Open Food Facts) ======
    async function lookupByBarcodeOFF(code){
      try{
        const r = await fetch(`https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(code)}.json`);
        const j = await r.json();
        if(j && j.status === 1){
          const p = j.product||{};
          return {
            name: p.product_name || p.generic_name || 'Unknown product',
            type: 'food',
            barcode: code,
            rating: '',
            notes: p.brands ? `Brand: ${p.brands}` : ''
          };
        }
      }catch(e){/* ignore */}
      return null;
    }

    // ====== Barcode scanner ======
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm';
    const codeReader = new BrowserMultiFormatReader();
    let currentStream = null;

    async function startScan(){
      const vid = el('preview');
      el('scanner').style.display = '';
      el('scanBtn').disabled = true; el('stopScanBtn').disabled = false;
      try{
        const devices = await BrowserMultiFormatReader.listVideoInputDevices();
        const deviceId = devices?.[0]?.deviceId;
        currentStream = await navigator.mediaDevices.getUserMedia({ video: { deviceId, facingMode: { ideal: 'environment' } } });
        vid.srcObject = currentStream; await vid.play();
        codeReader.decodeFromVideoDevice(deviceId || undefined, vid, async (res, err) => {
          if(res){
            const code = res.getText();
            el('barcode').value = code;
            setStatus(`Scanned: ${code}`);
            // pre-fill from local or external
            const local = await findByBarcode(code);
            if(local?.length){
              const it = local[0];
              el('name').value = it.name||''; el('type').value = it.type||'food'; el('rating').value = it.rating||''; el('notes').value = it.notes||'';
            }else{
              const fetched = await lookupByBarcodeOFF(code);
              if(fetched){
                el('name').value = fetched.name; el('type').value = fetched.type; el('notes').value = fetched.notes||'';
              }
            }
          }
        });
      }catch(e){ setStatus('Camera error: '+ e.message); }
    }
    function stopScan(){
      try{ codeReader.reset(); }catch(_){}
      if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream = null; }
      el('scanBtn').disabled = false; el('stopScanBtn').disabled = true; el('scanner').style.display = 'none';
    }

    // ====== Event wiring ======
    el('scanBtn').onclick = startScan;
    el('stopScanBtn').onclick = stopScan;
    el('addManualBtn').onclick = ()=>{ el('name').value=''; el('barcode').value=''; el('rating').value=''; el('notes').value=''; delete el('saveBtn').dataset.editing; setStatus('Ready to add.'); };
    el('clearBtn').onclick = ()=>{ el('name').value=''; el('barcode').value=''; el('rating').value=''; el('notes').value=''; delete el('saveBtn').dataset.editing; setStatus('Cleared.'); };
    el('saveBtn').onclick = async ()=>{
      const payload = {
        type: el('type').value||'food',
        name: el('name').value.trim(),
        barcode: el('barcode').value.trim(),
        rating: Number(el('rating').value||0),
        notes: el('notes').value.trim()
      };
      const editing = el('saveBtn').dataset.editing;
      if(editing){
        await updateItem(Number(editing), payload); setStatus('Updated.'); delete el('saveBtn').dataset.editing;
      }else{
        await addItem(payload); setStatus('Saved.');
      }
      renderList(await listAll());
    };
    el('searchBtn').onclick = async ()=>{ renderList(await searchByText(el('searchInput').value)); };
    el('showAllBtn').onclick = async ()=>{ renderList(await listAll()); };

    // Initial load
    renderList(await listAll());

    // PWA Service Worker
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
    }
</script>
</body>
</html>